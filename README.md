# 基于树模型的离网预测模型

    对于用户规模极大的企业而言，如电信运营商，旗下的用户数以万来计量。假设一个某地级市电信运营商运营着300万的用户，每月的存量用户流失率为0.5%，流失的用户规模1.5万人，又假定每个流失用户每月能带来38元营收，则每个月直接流失57万元。如果在能把所有预计流失的用户在其流失前进行营销，假定每月预计流失的客户中有10%因为营销活动而推迟一年离网，则每个月能为企业挽回损失接近70万元。在实际中，流失率越高、存量用户的价值越高，离网预测监控模型所挽回的营收价值越大。因此如何识别各个用户是否即将流失为运营商存量运营的重点工作之一。
    
## 实现工具
* Python3.x编程环境，sklearn算法库及其他科学计算、可视化库

## 一、数据准备

### 1.1 收集数据
  通常，运营商数据主要来自于BSS（业务支持系统）和OSS（运营支持系统）。BSS的数据主要分为四个部分：用户信息/行为数据、投诉数据、账单数据和通话/短信数据；而OSS的数据大致分为电路交换数据、分组交换数据和测量报告数据。一般而言，数据样本数量越大、字段信息维度越高则模型的准确率越高。所谓数据和特征决定了机器学习的上限，而模型和算法只是逼近这个上限的方法。在本次模拟中，我们以某市某运营商的中BSS系统中：用户信息/行为数据、账单数据和通话/短信数据作为建模数据，数据表主要分两类：
  
  * 月末在网用户明显表（6月、7月两个表）
  * 各月月末离网用户清单（7～11月）

### 1.2 定义目标变量
  * 正样本：当月在网但在未来四个月内离网的所有用户。
  * 负样本：当月在网且在未来四个月仍在网的所有用户。
  
### 1.3 字段描述
    在本次模型中从BBS系统所提取到的字段（共89个）及对应数据类型如下：
* 月份  ->  int64
* 号码  ->  int64
* 激活日期  ->  int64
* 品牌  ->  object
* 子品牌  ->  object
* 通信客户标志  ->  int64
* 活动天数  ->  int64
* 通信天数  ->  int64
* 主动通信天数  ->  int64
* 主动通信标志  ->  int64
* 网龄  ->  int64
* GPRS总流量  ->  float64
* 4G标志  ->  int64
* IMEI  ->  object
* 状态  ->  object
* 进入非正常时间  ->  float64
* 近三月平均ARPU  ->  float64
* 近三月平均流量  ->  float64
* 近三月平均MOU  ->  float64
* 家庭短号标识  ->  int64
* 新增通信标志  ->  int64
* 集团短号标识  ->  int64
* 所属集团名称  ->  object
* 年龄  ->  float64
* 证件  ->  object
* 镇区  ->  object
* 出账客户标识  ->  int64
* 细微区域  ->  object
* arpu  ->  float64
* 话费  ->  float64
* 月租  ->  int64
* GPRS费  ->  float64
* 家庭费  ->  float64
* 新业务费  ->  float64
* mou  ->  int64
* 主叫时长  ->  int64
* 被叫时长  ->  int64
* 实际收费分钟数  ->  int64
* 本地主叫本地时长  ->  int64
* 本地拨打长途时长  ->  int64
* 本地被叫时长  ->  int64
* 漫游时长  ->  int64
* 主叫次数  ->  int64
* 被叫次数  ->  int64
* 短信量  ->  int64
* 账户余额（已生效+未生效）  ->  float64
* 基本账户余额_已生效  ->  float64
* 赠送账户余额_已生效  ->  float64
* 基本账户余额_未生效  ->  float64
* 赠送账户余额_未生效  ->  float64
* 当月充值金额  ->  float64
* 当月充值次数  ->  int64
* 近半年充值总金额  ->  float64
* 近半年充值次数  ->  int64
* 套餐名称  ->  object
* 进入非正常次数  ->  int64
* 套餐外GPRS流量  ->  float64
* GPRS套餐外费用  ->  float64
* 省外GPRS流量  ->  float64
* 终端名称  ->  object
* 流量套餐饱和度  ->  float64
* 是否有彩铃功能  ->  int64
* 是否有来电显示  ->  int64
* 3g流量  ->  float64
* 4G流量  ->  float64
* 欠费金额  ->  float64
* 捆绑时长  ->  int64
* 集团代付标识  ->  int64
* 换卡标识  ->  int64
* 4g终端标识  ->  int64
* 持有周期（天）  ->  float64
* 证件ID  ->  float64
* 入网渠道  ->  object
* 渠道编码  ->  object
* 渠道归属镇区  ->  object
* 实名渠道名称  ->  object
* 实名定位镇区  ->  object
* 对应主卡  ->  object
* 副卡1  ->  object
* 副卡2  ->  object
* 一证X号_全网  ->  float64
* 一证X号_新增  ->  float64
* 新证标签  ->  float64
* 不限量标记  ->  int64
* 不限量订购时间  ->  float64
* 不限量生效时间  ->  float64
* 不限量名称  ->  object
* 省归属  ->  object
* 市归属  ->  float64

## 二、特征工程

### 2.1 筛选有营销价值的客户
    因为并不是所有客户都有营销价值，比如机器卡。一方面，即使能成功查准出来后，在营销的时候不进行过滤这部分客户，会造成营销资源浪费。另一方面，因为这部分客户没有营销价值，因此对模型数据会造成一定的干扰，营销整体模型的效果。因此在结合运营目标的基础上，在模型建立前先人为筛选出有用的样本，其筛选条件如下：
 * 子品牌：剔除万能副号、多号通副号、行业卡的用户
 * 网龄：剔除网龄不足8个月（入网当月则网龄为0）
 * 状态：仅含停机和正使用，其余的均剔除
 
 Note：根据筛选的条件可以看出本次模拟主要用于监控网龄一年或以上的用户的流失情况。
 
### 2.2 异常值过滤
    主要过滤于一些与现实一般情况相反的数据样本，过滤的条件如下：
   * 近三月平均ARPU：ARPU大于0才有意义，过滤掉ARPU不大于0的样本
   * 月租：月租必须非负
   * 流量套餐饱和度：部分样本数据被污染，需过滤掉数据类型为非数值型的样本
   
   
### 2.3 缺失剔除或填补、转换 
    对于某些字段数据少量缺失的，可以通过插值、填补等，而对于数据严重缺失的字段则剔除，避免引入额外的噪音数据。
   * 字段“进入非正常时间” 计算转换为 字段“进入非正常时间至今x日”
       - Note：数据缺失返回为 0；至今为 取数日期，在6月表中则为2018年6月30日；
       - 示例：“进入非正常时间” 为 20180610的样本，转换为 “进入非正常时间至今x日” 为20
               
               
   * 字段“不限量订购时间” 计算转换为 字段“不限量订购时间至今x月”
       - Note： 至今为 取数月份，在6月表中则为2018年6月；
       - 示例：“不限量订购时间” 为 20180610的样本，转换为 “不限量订购时间至今x月” 为0
       
       
   * 字段“不限量生效时间” 计算转换为 字段“不限量生效时间至今x月”
       - Note： 至今为 取数月份，在6月表中则为2018年6月；
       - 示例：“不限量生效时间” 为 20180610的样本，转换为 “不限量生效时间至今x月” 为0
       
       
   * 少量缺失字段填充为0：'年龄'、'出账客户标识'、'集团代付标识'、'一证X号_全网'、'一证X号_新增'、'新证标签'
   
   
   * 严重缺失字段进行剔除：'对应主卡'
   
   
   * 剔除经转换后信息多余的字段：'进入非正常时间','不限量订购时间', '不限量生效时间'
   
### 2.4 LabelEncoder / One - Hot
   * ‘状态'：换成 整数标签 （LabelEncoder）
   * '品牌'：进行One - Hot化处理

### 2.5 内生变量/构造新特征
    除了源数据表中本存在的特征和新转换引入的特征外，还可以根据业务运营逻辑，构造新的特征，以提高数据信息的多样性。
   *  ARPU增速 = arpu / 近三月平均ARPU - 1 
        - Note：如果 近三月平均ARPU == 0， 则默认 近三月平均ARPU = 1 再进行计算
        

   *  DOU增速 = GPRS总流量 / 近三月平均流量 - 1 
       -  Note：如果 近三月平均流量 == 0， 则默认 近三月平均流量 = 1 再进行计算
       

   *  MOU增速 = mou / 近三月MOU - 1 
       - Note：如果 近三月平均流量 == 0， 则默认 近三月平均流量 = 1 再进行计算
      
      
   *  账户余额/ARPU = 账户余额（已生效+未生效） / arpu
      - Note：如果 arpu 为0， 则输出 0


   * 基本账户余额/月租 = 基本账户余额_已生效 / 月租
      - Note：如果 月租 为0， 则输出 0


   * 省外GPRS流量/GPRS总流量 = 省外GPRS流量 / GPRS总流量
      - Note：如果 GPRS总流量 为0， 则输出 0


   * 4G流量/GPRS总流量 = 4G流量 / GPRS总流量
      - Note : 如果 GPRS总流量 为0， 则输出 0

### 2.6 特征选择/分析--互信息
    在某些模型中，数据特征不是越多越好。一方面，训练的数据过大，需要考虑到机器环境的配置、计算开销等问题；另一方面，部分特征具有高度线性相关，在某些线性回归/分类算法中会造成多重共线性问题即模型有偏、参数灵敏性、模型不显著等问题。因此需要通过一些手段先提前挑选相对有用的特征。在本环节中，我们通过最大互信息来比较各特征的重要程度。互信息(Mutual Information)可以表示两个变量是否有关系，以及关系的强弱。通过计算分析，可以计算出各特征的信息熵（已自高从低排序）：
    
 * '账户余额/ARPU' : 0.03632340503745237
 * '4G流量/GPRS总流量' : 0.03087718364687795
 * '4G流量' : 0.028465677444556758
 * 'ARPU增速' : 0.027686346408869893
 * '流量套餐饱和度' : 0.02384133500926183
 * 'GPRS总流量' : 0.0205703437371999
 * 'MOU增速' : 0.018558172107076235
 * '近三月平均流量' : 0.015625398746074458
 * 'DOU增速' : 0.0142324726333209
 * '基本账户余额/月租' : 0.012504438005217892
 * '账户余额（已生效+未生效）' : 0.009136052006099238
 * '近三月平均ARPU' : 0.006752648137609982
 * '套餐外GPRS流量' : 0.006473489600984667
 * '省外GPRS流量' : 0.006167278032064996
 * 'arpu' : 0.005948988305844767
 * '基本账户余额_已生效' : 0.0058125367051859245
 * '激活日期' : 0.005785245792763103
 * '网龄' : 0.0047720264952770715
 * '省外GPRS流量/GPRS总流量' : 0.004715524790062321
 * '被叫次数' : 0.0038220569318695285
 * '被叫时长' : 0.003673784824576918
 * '本地被叫时长' : 0.0036133043692564786
 * '近三月平均MOU' : 0.003593076962606409
 * 'mou' : 0.0035135098314976036
 * '活动天数' : 0.0033686808666840364
 * '本地主叫本地时长' : 0.003319240083677203
 * '主叫次数' : 0.0030854643667835835
 * '主叫时长' : 0.002946589414550644
 * '通信天数' : 0.002847685136214288
 * '主动通信天数' : 0.002847685136214288
 * '新业务费' : 0.002770142602001059
 * '欠费金额' : 0.0024167196566058638
 * '主动通信标志' : 0.001553606546171097
 * '本地拨打长途时长' : 0.0014832863946902782
 * '话费' : 0.0014788131355585805
 * '近半年充值总金额' : 0.0014485842968115848
 * '子品牌' : 0.0011308247067790037
 * '子品牌标签' : 0.0011308247067790037
 * '家庭短号标识' : 0.001130564916519812
 * 'GPRS费' : 0.001086393321520875
 * '品牌' : 0.0010552522441772405
 * '品牌标签' : 0.0010552522441772405
 * '3g流量' : 0.001033799234195291
 * '实际收费分钟数' : 0.0009331596509673529
 * '4G标志' : 0.0009159721914912891
 * '赠送账户余额_已生效' : 0.0008884199906662922
 * '月租' : 0.0008883122659532508
 * '不限量生效时间至今x月' : 0.0008488746214877036
 * '持有周期（天）' : 0.0007766327225461875
 * '不限量订购时间至今x月' : 0.0007575606042370181
 * '短信量' : 0.0006965154871109611
 * '赠送账户余额_未生效' : 0.0006963682058319433
 * '近半年充值次数' : 0.0006337280212786628
 * '进入非正常时间至今x日' : 0.0006045498315723958
 * '当月充值金额' : 0.0005614290429292027
 * '4g终端标识' : 0.0005097755796914863
 * '漫游时长' : 0.0004291519043200559
 * 'GPRS套餐外费用' : 0.0004279608292574301
 * '一证X号_全网' : 0.0004131586292242447
 * '年龄' : 0.00040755900729147937
 * '集团短号标识' : 0.00039023389291668225
 * '是否有彩铃功能' : 0.00037907912109636996
 * '家庭费' : 0.0003663793898008675
 * '当月充值次数' : 0.0003086911914567425
 * '状态' : 0.00030243720819742893
 * '状态标签' : 0.00030243720819742893
 * '捆绑时长' : 0.00019456245381678044
 * '进入非正常次数' : 0.00019257557381029502
 * '出账客户标识' : 0.00013819990844441896
 * '集团代付标识' : 0.00013133508017523147
 * '新增通信标志' : 5.065779908989523e-05
 * '一证X号_新增' : 4.637622638054258e-05
 * '换卡标识' : 1.6408926941096887e-05
 * '基本账户余额_未生效' : 1.172285604994783e-05
 * '通信客户标志' : 5.709857119459618e-06
 * '是否有来电显示' : 1.5272035365757237e-06
 * '新证标签' : 0.0
 * '不限量标记' : 0.0

    Anyway,在本次模型中，由于我们采用随机森林模型，可以通过模型自身的算法自动挑选出最优的模型特征。因此，以上出现的特征，我全要！
    ![image](我全要.jpeg)


## 三、数据集划分
    本次模型分析三个流程：训练、测试、验证。
    * 训练集：6月月末数据表随机划分70%作为模型训练
    * 测试集：6月月末数据表剩余30%作为模型测试
    * 验证集：7月月末数据表全部作为模型验证
    
    为了说明数据集划分具有完全的随机性，分别统计各数据集中正样本的比例，以避免样本偏差：
   * 样本总体规模：2825109， 其中train集规模 1977576 ；test集规模 847533
   * 总体中正样本的比例： 7.561442762031483 %
   * 训练集中正样本的比例： 7.561681573805508 %
   * 测试集中正样本的比例： 7.560885534840531 %

## 四、模型训练及评估

### 4.1 模型训练
    调用sklearn算法库中的随机森林算法，对训练集进行训练，模型参数为：
   * max_features :最大特征数 = 30
   * n_estimators :决策树数量 = 500
   * max_depth : 数的最大深度 = 10

### 4.2 模型评估
    针对三个数据集，模型分别输出各自样本在4个月内离网的概率，并自定义概率阈值，若样本概率超过该阈值，则判别其在未来4个月内会离网，应进行监控营销。根据自定义概率阈值的不同，可以划分出不同规模的预计会离网的用户，其查准率也会改变。一般来说，当概率阈值越高的时候，则模型预测会离网的用户规模越少，但其查准率越高。这样做的一个好处则是根据现有营销（优惠）资源有限的情况下，模型可以调控出相应规模离网概率最高的用户。
    
   * 随着查准率的提高，查准用户规模下降
   ![image](验证集_查准率vs预计离网规模.png)

   * 模型在训练集、测试集、验证集中对应的查准率、查全率、F1值指标
   ![image](概率阈值vs查准率_查全_F1值.png)
   
   * 模型ROC/AUC
   ![image](ROC_curve&AUC.png)
   
### 4.3 模型特征权重
    基于决策树的随机森林模型，评估中模型训练时对各特征权重的重要性如下（已自高向低排序），从排序结果可以看出用户是否活跃、欠费等行为特征、账单特征是判定一个用户似乎会离网的依据，这与现实事实一致。

 * '进入非正常时间至今x日' : 0.2147334480695638 
 * '活动天数' : 0.19355177638957616 
 * '欠费金额' : 0.1781850914215648 
 * '主动通信天数' : 0.07618952923549471 
 * '通信天数' : 0.06007359108182218 
 * '主动通信标志' : 0.05888715406936222 
 * '基本账户余额_已生效' : 0.031055947837074372 
 * '持有周期（天）' : 0.018416187801489608 
 * '状态标签' : 0.016084250633984394 
 * '激活日期' : 0.014468192858322543 
 * '账户余额/ARPU' : 0.0141779644062723 
 * 'ARPU增速' : 0.011798174778987067 
 * '出账客户标识' : 0.00915044751403943 
 * '网龄' : 0.008795223839269525 
 * 'arpu' : 0.006577576210771691 
 * '近三月平均MOU' : 0.005375616791996613 
 * '品牌标签' : 0.005165787821099962 
 * '账户余额（已生效+未生效）' : 0.005155477447237769 
 * '进入非正常次数' : 0.004779028722001224 
 * '近三月平均ARPU' : 0.004343521901473984 
 * '年龄' : 0.004061477940977163 
 * '基本账户余额/月租' : 0.0038294916821269924 
 * '赠送账户余额_未生效' : 0.0036755311663338335 
 * 'MOU增速' : 0.003459305965686226 
 * '不限量订购时间至今x月' : 0.0034501741937269063 
 * '近半年充值总金额' : 0.0031408023237188623 
 * '不限量生效时间至今x月' : 0.0028969788839583828 
 * '通信客户标志' : 0.0028084528332784926 
 * '被叫次数' : 0.0022953420128750787 
 * '近半年充值次数' : 0.001967919260952935 
 * '一证X号_全网' : 0.0019401691962265765 
 * '新业务费' : 0.0019122627783093877 
 * '月租' : 0.0018485572370935943 
 * '被叫时长' : 0.0017909208091327657 
 * '赠送账户余额_已生效' : 0.0016517981183053643 
 * '本地被叫时长' : 0.0016505557657291218 
 * '流量套餐饱和度' : 0.001433135622460294 
 * 'mou' : 0.0014026305241916066 
 * '4G流量/GPRS总流量' : 0.0013215542299351366 
 * 'DOU增速' : 0.0011252394125426343 
 * '当月充值金额' : 0.0010993252172315875 
 * '主叫时长' : 0.0010491253208978757 
 * '主叫次数' : 0.0010445306159226184 
 * '近三月平均流量' : 0.0010147947169850374 
 * 'GPRS总流量' : 0.0009733694204375231 
 * '本地主叫本地时长' : 0.0008793893377537073 
 * '省外GPRS流量' : 0.0008773423893841571 
 * '漫游时长' : 0.000875319218171546 
 * '当月充值次数' : 0.0007797018469371735 
 * '4G流量' : 0.0007766200002708468 
 * '本地拨打长途时长' : 0.0006523109275767789 
 * '省外GPRS流量/GPRS总流量' : 0.0006171952679477259 
 * '短信量' : 0.0005845412830554292 
 * 'GPRS费' : 0.0005688227172937088 
 * '捆绑时长' : 0.0004983121424798044 
 * '一证X号_新增' : 0.0004022325124166461 
 * '集团代付标识' : 0.0003230712964583613 
 * '3g流量' : 0.0003151564649093772 
 * '套餐外GPRS流量' : 0.0002990827089778405 
 * 'GPRS套餐外费用' : 0.00029759937559355475 
 * '是否有彩铃功能' : 0.0002973807950713144 
 * '话费' : 0.000292001663601113 
 * '实际收费分钟数' : 0.0002797594346708049 
 * '4g终端标识' : 0.00015907173362890347 
 * '家庭短号标识' : 0.00013801638160393752 
 * '集团短号标识' : 9.809515412839561e-05 
 * '4G标志' : 7.324480458160154e-05 
 * '家庭费' : 7.034514570564786e-05 
 * '换卡标识' : 1.6298935320808077e-05 
 * '新增通信标志' : 1.0927473782562387e-05 
 * '基本账户余额_未生效' : 1.072690823794535e-05 
 * '是否有来电显示' : 0.0 
 * '新证标签' : 0.0 
 * '不限量标记' : 0
 
 ## 结语

上面的模型模拟是真的有价值的营销主体客户而言，其中也包括了已停机但未离网但用户。从营销的角度来看，这部分用户离网概率大、营销难度高，可能需要加大优惠补贴力度。从模型角度来看，虽然可以先把所有离网用户预测出来，再根据当月状态是否正使用/停机进行划分，根据两个不同但群体分别营销。但一般情况下，建议先在原数据表上先根据用户状态划分两个子数据集，再分别建立两个不同但模型。这样模型的适用更有针对性，其精确率、查准率一般而言也会有一定的提高。

另外，就本次模型所用到的特征，已经获得相对高的查准率。如果能结合其他特征数据，如用户投诉行为数据、短信行为数据、上网速度、连接成功率等，相信模型也会有更进一步的效果。
